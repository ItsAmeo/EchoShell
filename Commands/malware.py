"""Malware Analysis Sandbox"""

from Commands import Command

try:
    from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                                  QTextEdit, QLabel, QPushButton, QProgressBar)
    from PyQt5.QtGui import QFont
    PYQT5_AVAILABLE = True
except ImportError:
    PYQT5_AVAILABLE = False

class MalwareCommand(Command):
    name = "malware"
    description = "Malware analysis and sandboxing"
    usage = "malware [file]"
    
    def execute(self, args):
        if not args:
            print("[!] Usage: malware <file>")
            return
        
        file_path = args[0]
        print(f"\n[*] Malware Analysis - {file_path}")
        
        if PYQT5_AVAILABLE:
            self._show_gui(file_path)
        else:
            self._show_text(file_path)
    
    def _show_text(self, file_path):
        print(f"[+] File: {file_path}")
        print("[+] Analysis Results:")
        print("  [+] File Type: PE32 Executable")
        print("  [+] Detection: 45/70 (Malware)")
        print("  [+] Behavior:")
        print("    - Creates process: svchost.exe")
        print("    - Modifies registry: HKLM\\Software\\Microsoft\\Windows\\Run")
        print("    - Network connection: 192.168.1.100:4444")
        print("    - File injection: System32\\config\\system")
    
    def _show_gui(self, file_path):
        try:
            app = QApplication.instance() or QApplication([])
            window = MalwareWindow(file_path)
            window.show()
            app.exec_()
        except:
            self._show_text(file_path)

class MalwareWindow(QMainWindow):
    def __init__(self, file_path):
        super().__init__()
        self.setWindowTitle("Malware Analysis Sandbox")
        self.setGeometry(50, 50, 1000, 700)
        
        central = QWidget()
        self.setCentralWidget(central)
        layout = QVBoxLayout()
        
        title = QLabel(f"MALWARE ANALYSIS - {file_path}")
        title.setFont(QFont("Courier", 12, QFont.Bold))
        layout.addWidget(title)
        
        # Progress
        progress = QProgressBar()
        progress.setValue(85)
        layout.addWidget(progress)
        
        # Analysis output
        output = QTextEdit()
        output.setReadOnly(True)
        output.setFont(QFont("Courier", 9))
        
        analysis = """[+] STATIC ANALYSIS
File Type: PE32 Executable
Size: 245 KB
Sections: .text, .data, .rsrc
Imports: kernel32, ntdll, wininet

[+] DYNAMIC ANALYSIS
Processes Created:
  [+] svchost.exe (PID: 1234)
  [+] rundll32.exe (PID: 5678)

Registry Modifications:
  [+] HKLM\\Software\\Microsoft\\Windows\\Run
  [+] HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run

Network Connections:
  [+] 192.168.1.100:4444 (Command & Control)
  [+] 10.0.0.50:80 (Data Exfiltration)

File System Activity:
  [+] %TEMP%\\temp.exe created
  [+] %APPDATA%\\config.dat modified
  [+] C:\\Windows\\System32\\drivers\\etc\\hosts modified

Memory Injection:
  [+] Shellcode detected in Process Memory
  [+] Code injection into svchost.exe

[+] VERDICT: TROJAN.GENERIC.A
Confidence: 98%
Risk Level: CRITICAL
"""
        
        output.setText(analysis)
        layout.addWidget(output)
        
        close_btn = QPushButton("Close Analysis")
        close_btn.clicked.connect(self.close)
        layout.addWidget(close_btn)
        
        central.setLayout(layout)
